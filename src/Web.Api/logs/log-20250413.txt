2025-04-13 12:31:53.106 +04:00 [INF] User profile is available. Using 'C:\Users\User\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-04-13 12:31:54.114 +04:00 [INF] Now listening on: https://localhost:7289
2025-04-13 12:31:54.146 +04:00 [INF] Now listening on: http://localhost:5287
2025-04-13 12:31:54.434 +04:00 [INF] Application started. Press Ctrl+C to shut down.
2025-04-13 12:31:54.469 +04:00 [INF] Hosting environment: Development
2025-04-13 12:31:54.479 +04:00 [INF] Content root path: C:\Users\User\Desktop\PRO-JECT\src\Web.Api
2025-04-13 12:33:57.799 +04:00 [INF] Request starting HTTP/1.1 POST https://localhost:7289/api/auth/login - application/json 41
2025-04-13 12:33:58.320 +04:00 [INF] Executing endpoint 'Web.Api.Controllers.AuthController.SignIn (Web.Api)'
2025-04-13 12:33:58.537 +04:00 [INF] Route matched with {action = "SignIn", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SignIn(Core.Infrastructure.Persistence.Users.Features.Dtos.LoginDto) on controller Web.Api.Controllers.AuthController (Web.Api).
2025-04-13 12:33:58.779 +04:00 [INF] Handling request: UserRegisterOrLoginCommand, Data: {"email":"alizadeemil5@gmail.com","ipAddress":"0.0.0.1","$type":"UserRegisterOrLoginCommand"}
2025-04-13 12:34:10.841 +04:00 [INF] Executed DbCommand (195ms) [Parameters=[@__email_0='?' (Size = 50)], CommandType='"Text"', CommandTimeout='30']
SELECT [u2].[Id], [u2].[Bio], [u2].[Country], [u2].[CreatedDate], [u2].[DateOfBirth], [u2].[Email], [u2].[FirstName], [u2].[Gender], [u2].[LastName], [u2].[ModifiedDate], [s].[UserId], [s].[RoleId], [s].[Id], [s].[Role]
FROM (
    SELECT TOP(1) [u].[Id], [u].[Bio], [u].[Country], [u].[CreatedDate], [u].[DateOfBirth], [u].[Email], [u].[FirstName], [u].[Gender], [u].[LastName], [u].[ModifiedDate]
    FROM [Users] AS [u]
    WHERE [u].[Email] = @__email_0
) AS [u2]
LEFT JOIN (
    SELECT [u0].[UserId], [u0].[RoleId], [u1].[Id], [u1].[Role]
    FROM [UserAndUserRoles] AS [u0]
    INNER JOIN [UserRoles] AS [u1] ON [u0].[RoleId] = [u1].[Id]
) AS [s] ON [u2].[Id] = [s].[UserId]
ORDER BY [u2].[Id], [s].[UserId], [s].[RoleId]
2025-04-13 12:34:11.108 +04:00 [INF] Executed DbCommand (49ms) [Parameters=[@__email_0='?' (Size = 50)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Users] AS [u]
        WHERE [u].[Email] = @__email_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-04-13 12:34:12.268 +04:00 [ERR] Failed executing DbCommand (174ms) [Parameters=[@p0='?' (DbType = Guid), @p1='?' (DbType = DateTime2), @p2='?' (Size = 100), @p3='?' (DbType = DateTime2), @p4='?' (Size = 6), @p5='?' (DbType = DateTime2), @p6='?' (Size = 500), @p7='?' (DbType = DateTime2), @p8='?' (DbType = Guid)], CommandType='"Text"', CommandTimeout='30']
SET IMPLICIT_TRANSACTIONS OFF;
SET NOCOUNT ON;
INSERT INTO [SecurityDetails] ([Id], [CreatedDate], [IPAddress], [ModifiedDate], [OTPCode], [OTPExpiryDate], [RefreshToken], [RefreshTokenExpirationDate], [UserId])
VALUES (@p0, @p1, @p2, @p3, @p4, @p5, @p6, @p7, @p8);
2025-04-13 12:34:12.430 +04:00 [ERR] An exception occurred in the database while saving changes for context type 'Core.Infrastructure.Persistence.Users.Context.UserDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): Cannot insert duplicate key row in object 'dbo.SecurityDetails' with unique index 'IX_SecurityDetails_UserId'. The duplicate key value is (5b6b0d43-680a-4bd2-87d6-93dc69803027).
The statement has been terminated.
   at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__211_0(Task`1 result)
   at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
ClientConnectionId:e73d479f-ff21-477f-8677-31db247759d0
Error Number:2601,State:1,Class:14
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): Cannot insert duplicate key row in object 'dbo.SecurityDetails' with unique index 'IX_SecurityDetails_UserId'. The duplicate key value is (5b6b0d43-680a-4bd2-87d6-93dc69803027).
The statement has been terminated.
   at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__211_0(Task`1 result)
   at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
ClientConnectionId:e73d479f-ff21-477f-8677-31db247759d0
Error Number:2601,State:1,Class:14
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-04-13 12:34:15.452 +04:00 [ERR] Request UserRegisterOrLoginCommand failed.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): Cannot insert duplicate key row in object 'dbo.SecurityDetails' with unique index 'IX_SecurityDetails_UserId'. The duplicate key value is (5b6b0d43-680a-4bd2-87d6-93dc69803027).
The statement has been terminated.
   at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__211_0(Task`1 result)
   at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
ClientConnectionId:e73d479f-ff21-477f-8677-31db247759d0
Error Number:2601,State:1,Class:14
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Core.Application.Repositories.UnitOfWork`1.CommitAsync(CancellationToken cancellationToken) in C:\Users\User\Desktop\PRO-JECT\src\Core.Application\Repositories\UnitOfWork.cs:line 11
   at Core.Application.Abstractions.CommandHandler`2.Handle(TRequest request, CancellationToken cancellationToken) in C:\Users\User\Desktop\PRO-JECT\src\Core.Application\Abstractions\CommandHandler.cs:line 24
   at Core.Application.Behaviors.Validations.ValidationBehavior`2.Handle(TRequest request, RequestHandlerDelegate`1 next, CancellationToken cancellationToken) in C:\Users\User\Desktop\PRO-JECT\src\Core.Application\Behaviors\Validations\ValidationBehavior.cs:line 30
   at LoggingBehavior`2.Handle(TRequest request, RequestHandlerDelegate`1 next, CancellationToken cancellationToken) in C:\Users\User\Desktop\PRO-JECT\src\Core.Application\Behaviors\Logging\LoggingBehavior.cs:line 21
2025-04-13 12:38:49.558 +04:00 [INF] Executed action Web.Api.Controllers.AuthController.SignIn (Web.Api) in 290984.628ms
2025-04-13 12:38:49.827 +04:00 [INF] Executed endpoint 'Web.Api.Controllers.AuthController.SignIn (Web.Api)'
2025-04-13 12:38:49.849 +04:00 [ERR] An unhandled exception has occurred while executing the request.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): Cannot insert duplicate key row in object 'dbo.SecurityDetails' with unique index 'IX_SecurityDetails_UserId'. The duplicate key value is (5b6b0d43-680a-4bd2-87d6-93dc69803027).
The statement has been terminated.
   at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__211_0(Task`1 result)
   at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
ClientConnectionId:e73d479f-ff21-477f-8677-31db247759d0
Error Number:2601,State:1,Class:14
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Core.Application.Repositories.UnitOfWork`1.CommitAsync(CancellationToken cancellationToken) in C:\Users\User\Desktop\PRO-JECT\src\Core.Application\Repositories\UnitOfWork.cs:line 11
   at Core.Application.Abstractions.CommandHandler`2.Handle(TRequest request, CancellationToken cancellationToken) in C:\Users\User\Desktop\PRO-JECT\src\Core.Application\Abstractions\CommandHandler.cs:line 24
   at Core.Application.Behaviors.Validations.ValidationBehavior`2.Handle(TRequest request, RequestHandlerDelegate`1 next, CancellationToken cancellationToken) in C:\Users\User\Desktop\PRO-JECT\src\Core.Application\Behaviors\Validations\ValidationBehavior.cs:line 30
   at LoggingBehavior`2.Handle(TRequest request, RequestHandlerDelegate`1 next, CancellationToken cancellationToken) in C:\Users\User\Desktop\PRO-JECT\src\Core.Application\Behaviors\Logging\LoggingBehavior.cs:line 21
   at Web.Api.Controllers.AuthController.SignIn(LoginDto login) in C:\Users\User\Desktop\PRO-JECT\src\Web.Api\Controllers\AuthController.cs:line 17
   at Microsoft.AspNetCore.Mvc.Infrastructure.ActionMethodExecutor.TaskOfIActionResultExecutor.Execute(ActionContext actionContext, IActionResultTypeMapper mapper, ObjectMethodExecutor executor, Object controller, Object[] arguments)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.<InvokeActionMethodAsync>g__Awaited|12_0(ControllerActionInvoker invoker, ValueTask`1 actionResultValueTask)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.<InvokeNextActionFilterAsync>g__Awaited|10_0(ControllerActionInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.Rethrow(ActionExecutedContextSealed context)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.Next(State& next, Scope& scope, Object& state, Boolean& isCompleted)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ControllerActionInvoker.<InvokeInnerFilterAsync>g__Awaited|13_0(ControllerActionInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeFilterPipelineAsync>g__Awaited|20_0(ResourceInvoker invoker, Task lastTask, State next, Scope scope, Object state, Boolean isCompleted)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeAsync>g__Logged|17_1(ResourceInvoker invoker)
   at Microsoft.AspNetCore.Mvc.Infrastructure.ResourceInvoker.<InvokeAsync>g__Logged|17_1(ResourceInvoker invoker)
   at Microsoft.AspNetCore.Routing.EndpointMiddleware.<Invoke>g__AwaitRequestTask|7_0(Endpoint endpoint, Task requestTask, ILogger logger)
   at Microsoft.AspNetCore.Authorization.AuthorizationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Authentication.AuthenticationMiddleware.Invoke(HttpContext context)
   at Microsoft.AspNetCore.Diagnostics.DeveloperExceptionPageMiddlewareImpl.Invoke(HttpContext context)
2025-04-13 12:39:16.635 +04:00 [INF] User profile is available. Using 'C:\Users\User\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-04-13 12:39:17.553 +04:00 [INF] Now listening on: https://localhost:7289
2025-04-13 12:39:17.557 +04:00 [INF] Now listening on: http://localhost:5287
2025-04-13 12:39:17.765 +04:00 [INF] Application started. Press Ctrl+C to shut down.
2025-04-13 12:39:17.839 +04:00 [INF] Hosting environment: Development
2025-04-13 12:39:17.852 +04:00 [INF] Content root path: C:\Users\User\Desktop\PRO-JECT\src\Web.Api
2025-04-13 12:39:28.198 +04:00 [INF] Request starting HTTP/1.1 POST https://localhost:7289/api/auth/login - application/json 41
2025-04-13 12:39:28.528 +04:00 [INF] Executing endpoint 'Web.Api.Controllers.AuthController.SignIn (Web.Api)'
2025-04-13 12:39:28.651 +04:00 [INF] Route matched with {action = "SignIn", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SignIn(Core.Infrastructure.Persistence.Users.Features.Dtos.LoginDto) on controller Web.Api.Controllers.AuthController (Web.Api).
2025-04-13 12:39:28.866 +04:00 [INF] Handling request: UserRegisterOrLoginCommand, Data: {"email":"alizadeemil5@gmail.com","ipAddress":"0.0.0.1","$type":"UserRegisterOrLoginCommand"}
2025-04-13 12:39:35.631 +04:00 [INF] Executed DbCommand (112ms) [Parameters=[@__email_0='?' (Size = 50)], CommandType='"Text"', CommandTimeout='30']
SELECT [u2].[Id], [u2].[Bio], [u2].[Country], [u2].[CreatedDate], [u2].[DateOfBirth], [u2].[Email], [u2].[FirstName], [u2].[Gender], [u2].[LastName], [u2].[ModifiedDate], [s].[UserId], [s].[RoleId], [s].[Id], [s].[Role]
FROM (
    SELECT TOP(1) [u].[Id], [u].[Bio], [u].[Country], [u].[CreatedDate], [u].[DateOfBirth], [u].[Email], [u].[FirstName], [u].[Gender], [u].[LastName], [u].[ModifiedDate]
    FROM [Users] AS [u]
    WHERE [u].[Email] = @__email_0
) AS [u2]
LEFT JOIN (
    SELECT [u0].[UserId], [u0].[RoleId], [u1].[Id], [u1].[Role]
    FROM [UserAndUserRoles] AS [u0]
    INNER JOIN [UserRoles] AS [u1] ON [u0].[RoleId] = [u1].[Id]
) AS [s] ON [u2].[Id] = [s].[UserId]
ORDER BY [u2].[Id], [s].[UserId], [s].[RoleId]
2025-04-13 12:39:35.832 +04:00 [INF] Executed DbCommand (11ms) [Parameters=[@__email_0='?' (Size = 50)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Users] AS [u]
        WHERE [u].[Email] = @__email_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-04-13 12:43:50.312 +04:00 [INF] User profile is available. Using 'C:\Users\User\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-04-13 12:43:51.294 +04:00 [INF] Now listening on: https://localhost:7289
2025-04-13 12:43:51.298 +04:00 [INF] Now listening on: http://localhost:5287
2025-04-13 12:43:51.514 +04:00 [INF] Application started. Press Ctrl+C to shut down.
2025-04-13 12:43:51.519 +04:00 [INF] Hosting environment: Development
2025-04-13 12:43:51.521 +04:00 [INF] Content root path: C:\Users\User\Desktop\PRO-JECT\src\Web.Api
2025-04-13 12:44:09.469 +04:00 [INF] Request starting HTTP/1.1 POST https://localhost:7289/api/auth/login - application/json 41
2025-04-13 12:44:09.831 +04:00 [INF] Executing endpoint 'Web.Api.Controllers.AuthController.SignIn (Web.Api)'
2025-04-13 12:44:09.985 +04:00 [INF] Route matched with {action = "SignIn", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SignIn(Core.Infrastructure.Persistence.Users.Features.Dtos.LoginDto) on controller Web.Api.Controllers.AuthController (Web.Api).
2025-04-13 12:44:10.155 +04:00 [INF] Handling request: UserRegisterOrLoginCommand, Data: {"email":"alizadeemil5@gmail.com","ipAddress":"0.0.0.1","$type":"UserRegisterOrLoginCommand"}
2025-04-13 12:44:26.167 +04:00 [INF] Executed DbCommand (157ms) [Parameters=[@__email_0='?' (Size = 50)], CommandType='"Text"', CommandTimeout='30']
SELECT [s0].[Id], [s0].[Bio], [s0].[Country], [s0].[CreatedDate], [s0].[DateOfBirth], [s0].[Email], [s0].[FirstName], [s0].[Gender], [s0].[LastName], [s0].[ModifiedDate], [s0].[Id0], [s1].[UserId], [s1].[RoleId], [s1].[Id], [s1].[Role], [s0].[CreatedDate0], [s0].[IPAddress], [s0].[ModifiedDate0], [s0].[OTPCode], [s0].[OTPExpiryDate], [s0].[RefreshToken], [s0].[RefreshTokenExpirationDate], [s0].[UserId]
FROM (
    SELECT TOP(1) [u].[Id], [u].[Bio], [u].[Country], [u].[CreatedDate], [u].[DateOfBirth], [u].[Email], [u].[FirstName], [u].[Gender], [u].[LastName], [u].[ModifiedDate], [s].[Id] AS [Id0], [s].[CreatedDate] AS [CreatedDate0], [s].[IPAddress], [s].[ModifiedDate] AS [ModifiedDate0], [s].[OTPCode], [s].[OTPExpiryDate], [s].[RefreshToken], [s].[RefreshTokenExpirationDate], [s].[UserId]
    FROM [Users] AS [u]
    LEFT JOIN [SecurityDetails] AS [s] ON [u].[Id] = [s].[UserId]
    WHERE [u].[Email] = @__email_0
) AS [s0]
LEFT JOIN (
    SELECT [u0].[UserId], [u0].[RoleId], [u1].[Id], [u1].[Role]
    FROM [UserAndUserRoles] AS [u0]
    INNER JOIN [UserRoles] AS [u1] ON [u0].[RoleId] = [u1].[Id]
) AS [s1] ON [s0].[Id] = [s1].[UserId]
ORDER BY [s0].[Id], [s0].[Id0], [s1].[UserId], [s1].[RoleId]
2025-04-13 12:44:39.878 +04:00 [INF] Executed DbCommand (34ms) [Parameters=[@__email_0='?' (Size = 50)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Users] AS [u]
        WHERE [u].[Email] = @__email_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-04-13 12:44:50.876 +04:00 [ERR] Failed executing DbCommand (165ms) [Parameters=[@p0='?' (DbType = Int32), @p1='?' (Size = 50), @p2='?' (DbType = Guid), @p3='?' (Size = 500), @p4='?' (Size = 50), @p5='?' (DbType = DateTime2), @p6='?' (DbType = DateTime2), @p7='?' (Size = 50), @p8='?' (Size = 50), @p9='?' (DbType = Int32), @p10='?' (Size = 50), @p11='?' (DbType = DateTime2), @p12='?' (DbType = Guid), @p13='?' (DbType = DateTime2), @p14='?' (Size = 100), @p15='?' (DbType = DateTime2), @p16='?' (Size = 6), @p17='?' (DbType = DateTime2), @p18='?' (Size = 500), @p19='?' (DbType = DateTime2), @p20='?' (DbType = Guid), @p21='?' (DbType = Int32), @p22='?' (DbType = Guid)], CommandType='"Text"', CommandTimeout='30']
SET NOCOUNT ON;
INSERT INTO [UserRoles] ([Id], [Role])
VALUES (@p0, @p1);
INSERT INTO [Users] ([Id], [Bio], [Country], [CreatedDate], [DateOfBirth], [Email], [FirstName], [Gender], [LastName], [ModifiedDate])
VALUES (@p2, @p3, @p4, @p5, @p6, @p7, @p8, @p9, @p10, @p11);
INSERT INTO [SecurityDetails] ([Id], [CreatedDate], [IPAddress], [ModifiedDate], [OTPCode], [OTPExpiryDate], [RefreshToken], [RefreshTokenExpirationDate], [UserId])
VALUES (@p12, @p13, @p14, @p15, @p16, @p17, @p18, @p19, @p20);
INSERT INTO [UserAndUserRoles] ([RoleId], [UserId])
VALUES (@p21, @p22);
2025-04-13 12:44:50.986 +04:00 [ERR] An exception occurred in the database while saving changes for context type 'Core.Infrastructure.Persistence.Users.Context.UserDbContext'.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): Cannot insert explicit value for identity column in table 'UserRoles' when IDENTITY_INSERT is set to OFF.
Violation of PRIMARY KEY constraint 'PK_Users'. Cannot insert duplicate key in object 'dbo.Users'. The duplicate key value is (5b6b0d43-680a-4bd2-87d6-93dc69803027).
Violation of PRIMARY KEY constraint 'PK_SecurityDetails'. Cannot insert duplicate key in object 'dbo.SecurityDetails'. The duplicate key value is (4dba3ab0-936f-4d0e-9b35-b55a5f0b3933).
Violation of PRIMARY KEY constraint 'PK_UserAndUserRoles'. Cannot insert duplicate key in object 'dbo.UserAndUserRoles'. The duplicate key value is (5b6b0d43-680a-4bd2-87d6-93dc69803027, 2).
The statement has been terminated.
The statement has been terminated.
The statement has been terminated.
   at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__211_0(Task`1 result)
   at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
ClientConnectionId:ae43f131-17e8-405f-ac98-5d6698356e2f
Error Number:544,State:1,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): Cannot insert explicit value for identity column in table 'UserRoles' when IDENTITY_INSERT is set to OFF.
Violation of PRIMARY KEY constraint 'PK_Users'. Cannot insert duplicate key in object 'dbo.Users'. The duplicate key value is (5b6b0d43-680a-4bd2-87d6-93dc69803027).
Violation of PRIMARY KEY constraint 'PK_SecurityDetails'. Cannot insert duplicate key in object 'dbo.SecurityDetails'. The duplicate key value is (4dba3ab0-936f-4d0e-9b35-b55a5f0b3933).
Violation of PRIMARY KEY constraint 'PK_UserAndUserRoles'. Cannot insert duplicate key in object 'dbo.UserAndUserRoles'. The duplicate key value is (5b6b0d43-680a-4bd2-87d6-93dc69803027, 2).
The statement has been terminated.
The statement has been terminated.
The statement has been terminated.
   at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__211_0(Task`1 result)
   at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
ClientConnectionId:ae43f131-17e8-405f-ac98-5d6698356e2f
Error Number:544,State:1,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
2025-04-13 12:44:53.690 +04:00 [ERR] Request UserRegisterOrLoginCommand failed.
Microsoft.EntityFrameworkCore.DbUpdateException: An error occurred while saving the entity changes. See the inner exception for details.
 ---> Microsoft.Data.SqlClient.SqlException (0x80131904): Cannot insert explicit value for identity column in table 'UserRoles' when IDENTITY_INSERT is set to OFF.
Violation of PRIMARY KEY constraint 'PK_Users'. Cannot insert duplicate key in object 'dbo.Users'. The duplicate key value is (5b6b0d43-680a-4bd2-87d6-93dc69803027).
Violation of PRIMARY KEY constraint 'PK_SecurityDetails'. Cannot insert duplicate key in object 'dbo.SecurityDetails'. The duplicate key value is (4dba3ab0-936f-4d0e-9b35-b55a5f0b3933).
Violation of PRIMARY KEY constraint 'PK_UserAndUserRoles'. Cannot insert duplicate key in object 'dbo.UserAndUserRoles'. The duplicate key value is (5b6b0d43-680a-4bd2-87d6-93dc69803027, 2).
The statement has been terminated.
The statement has been terminated.
The statement has been terminated.
   at Microsoft.Data.SqlClient.SqlCommand.<>c.<ExecuteDbDataReaderAsync>b__211_0(Task`1 result)
   at System.Threading.Tasks.ContinuationResultTaskFromResultTask`2.InnerInvoke()
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
--- End of stack trace from previous location ---
   at System.Threading.ExecutionContext.RunInternal(ExecutionContext executionContext, ContextCallback callback, Object state)
   at System.Threading.Tasks.Task.ExecuteWithThreadLocal(Task& currentTaskSlot, Thread threadPoolThread)
--- End of stack trace from previous location ---
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalCommand.ExecuteReaderAsync(RelationalCommandParameterObject parameterObject, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
ClientConnectionId:ae43f131-17e8-405f-ac98-5d6698356e2f
Error Number:544,State:1,Class:16
   --- End of inner exception stack trace ---
   at Microsoft.EntityFrameworkCore.Update.ReaderModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Update.Internal.SqlServerModificationCommandBatch.ExecuteAsync(IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Update.Internal.BatchExecutor.ExecuteAsync(IEnumerable`1 commandBatches, IRelationalConnection connection, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.Storage.RelationalDatabase.SaveChangesAsync(IList`1 entries, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(IList`1 entriesToSave, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.ChangeTracking.Internal.StateManager.SaveChangesAsync(StateManager stateManager, Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.SqlServer.Storage.Internal.SqlServerExecutionStrategy.ExecuteAsync[TState,TResult](TState state, Func`4 operation, Func`4 verifySucceeded, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Microsoft.EntityFrameworkCore.DbContext.SaveChangesAsync(Boolean acceptAllChangesOnSuccess, CancellationToken cancellationToken)
   at Core.Application.Repositories.UnitOfWork`1.CommitAsync(CancellationToken cancellationToken) in C:\Users\User\Desktop\PRO-JECT\src\Core.Application\Repositories\UnitOfWork.cs:line 11
   at Core.Application.Abstractions.CommandHandler`2.Handle(TRequest request, CancellationToken cancellationToken) in C:\Users\User\Desktop\PRO-JECT\src\Core.Application\Abstractions\CommandHandler.cs:line 24
   at Core.Application.Behaviors.Validations.ValidationBehavior`2.Handle(TRequest request, RequestHandlerDelegate`1 next, CancellationToken cancellationToken) in C:\Users\User\Desktop\PRO-JECT\src\Core.Application\Behaviors\Validations\ValidationBehavior.cs:line 30
   at LoggingBehavior`2.Handle(TRequest request, RequestHandlerDelegate`1 next, CancellationToken cancellationToken) in C:\Users\User\Desktop\PRO-JECT\src\Core.Application\Behaviors\Logging\LoggingBehavior.cs:line 21
2025-04-13 13:00:55.675 +04:00 [INF] User profile is available. Using 'C:\Users\User\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-04-13 13:00:56.847 +04:00 [INF] Now listening on: https://localhost:7289
2025-04-13 13:00:56.853 +04:00 [INF] Now listening on: http://localhost:5287
2025-04-13 13:00:57.113 +04:00 [INF] Application started. Press Ctrl+C to shut down.
2025-04-13 13:00:57.121 +04:00 [INF] Hosting environment: Development
2025-04-13 13:00:57.127 +04:00 [INF] Content root path: C:\Users\User\Desktop\PRO-JECT\src\Web.Api
2025-04-13 13:01:01.625 +04:00 [INF] Request starting HTTP/1.1 POST https://localhost:7289/api/auth/login - application/json 41
2025-04-13 13:01:01.937 +04:00 [INF] Executing endpoint 'Web.Api.Controllers.AuthController.SignIn (Web.Api)'
2025-04-13 13:01:02.056 +04:00 [INF] Route matched with {action = "SignIn", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SignIn(Core.Infrastructure.Persistence.Users.Features.Dtos.LoginDto) on controller Web.Api.Controllers.AuthController (Web.Api).
2025-04-13 13:01:02.258 +04:00 [INF] Handling request: UserRegisterOrLoginCommand, Data: {"email":"alizadeemil5@gmail.com","ipAddress":"0.0.0.1","$type":"UserRegisterOrLoginCommand"}
2025-04-13 13:01:16.268 +04:00 [INF] Executed DbCommand (228ms) [Parameters=[@__email_0='?' (Size = 50)], CommandType='"Text"', CommandTimeout='30']
SELECT [s0].[Id], [s0].[Bio], [s0].[Country], [s0].[CreatedDate], [s0].[DateOfBirth], [s0].[Email], [s0].[FirstName], [s0].[Gender], [s0].[LastName], [s0].[ModifiedDate], [s0].[Id0], [s1].[UserId], [s1].[RoleId], [s1].[Id], [s1].[Role], [s0].[CreatedDate0], [s0].[IPAddress], [s0].[ModifiedDate0], [s0].[OTPCode], [s0].[OTPExpiryDate], [s0].[RefreshToken], [s0].[RefreshTokenExpirationDate], [s0].[UserId]
FROM (
    SELECT TOP(1) [u].[Id], [u].[Bio], [u].[Country], [u].[CreatedDate], [u].[DateOfBirth], [u].[Email], [u].[FirstName], [u].[Gender], [u].[LastName], [u].[ModifiedDate], [s].[Id] AS [Id0], [s].[CreatedDate] AS [CreatedDate0], [s].[IPAddress], [s].[ModifiedDate] AS [ModifiedDate0], [s].[OTPCode], [s].[OTPExpiryDate], [s].[RefreshToken], [s].[RefreshTokenExpirationDate], [s].[UserId]
    FROM [Users] AS [u]
    LEFT JOIN [SecurityDetails] AS [s] ON [u].[Id] = [s].[UserId]
    WHERE [u].[Email] = @__email_0
) AS [s0]
LEFT JOIN (
    SELECT [u0].[UserId], [u0].[RoleId], [u1].[Id], [u1].[Role]
    FROM [UserAndUserRoles] AS [u0]
    INNER JOIN [UserRoles] AS [u1] ON [u0].[RoleId] = [u1].[Id]
) AS [s1] ON [s0].[Id] = [s1].[UserId]
ORDER BY [s0].[Id], [s0].[Id0], [s1].[UserId], [s1].[RoleId]
2025-04-13 13:01:18.876 +04:00 [INF] Executed DbCommand (16ms) [Parameters=[@__email_0='?' (Size = 50)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Users] AS [u]
        WHERE [u].[Email] = @__email_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-04-13 13:01:41.918 +04:00 [INF] Executed DbCommand (450ms) [Parameters=[@p8='?' (DbType = Guid), @p0='?' (DbType = DateTime2), @p1='?' (Size = 100), @p2='?' (DbType = DateTime2), @p3='?' (Size = 6), @p4='?' (DbType = DateTime2), @p5='?' (Size = 500), @p6='?' (DbType = DateTime2), @p7='?' (DbType = Guid), @p10='?' (DbType = Int32), @p9='?' (Size = 50), @p20='?' (DbType = Guid), @p11='?' (Size = 500), @p12='?' (Size = 50), @p13='?' (DbType = DateTime2), @p14='?' (DbType = DateTime2), @p15='?' (Size = 50), @p16='?' (Size = 50), @p17='?' (DbType = Int32), @p18='?' (Size = 50), @p19='?' (DbType = DateTime2)], CommandType='"Text"', CommandTimeout='30']
SET NOCOUNT ON;
UPDATE [SecurityDetails] SET [CreatedDate] = @p0, [IPAddress] = @p1, [ModifiedDate] = @p2, [OTPCode] = @p3, [OTPExpiryDate] = @p4, [RefreshToken] = @p5, [RefreshTokenExpirationDate] = @p6, [UserId] = @p7
OUTPUT 1
WHERE [Id] = @p8;
UPDATE [UserRoles] SET [Role] = @p9
OUTPUT 1
WHERE [Id] = @p10;
UPDATE [Users] SET [Bio] = @p11, [Country] = @p12, [CreatedDate] = @p13, [DateOfBirth] = @p14, [Email] = @p15, [FirstName] = @p16, [Gender] = @p17, [LastName] = @p18, [ModifiedDate] = @p19
OUTPUT 1
WHERE [Id] = @p20;
2025-04-13 13:01:46.993 +04:00 [ERR] Request UserRegisterOrLoginCommand failed.
Newtonsoft.Json.JsonSerializationException: Self referencing loop detected for property 'SecurityDetails' with type 'Core.Domain.Entities.SecurityDetails'. Path 'otp.User'.
   at Newtonsoft.Json.Serialization.JsonSerializerInternalWriter.CheckForCircularReference(JsonWriter writer, Object value, JsonProperty property, JsonContract contract, JsonContainerContract containerContract, JsonProperty containerProperty)
   at Newtonsoft.Json.Serialization.JsonSerializerInternalWriter.CalculatePropertyValues(JsonWriter writer, Object value, JsonContainerContract contract, JsonProperty member, JsonProperty property, JsonContract& memberContract, Object& memberValue)
   at Newtonsoft.Json.Serialization.JsonSerializerInternalWriter.SerializeObject(JsonWriter writer, Object value, JsonObjectContract contract, JsonProperty member, JsonContainerContract collectionContract, JsonProperty containerProperty)
   at Newtonsoft.Json.Serialization.JsonSerializerInternalWriter.SerializeValue(JsonWriter writer, Object value, JsonContract valueContract, JsonProperty member, JsonContainerContract containerContract, JsonProperty containerProperty)
   at Newtonsoft.Json.Serialization.JsonSerializerInternalWriter.SerializeObject(JsonWriter writer, Object value, JsonObjectContract contract, JsonProperty member, JsonContainerContract collectionContract, JsonProperty containerProperty)
   at Newtonsoft.Json.Serialization.JsonSerializerInternalWriter.SerializeValue(JsonWriter writer, Object value, JsonContract valueContract, JsonProperty member, JsonContainerContract containerContract, JsonProperty containerProperty)
   at Newtonsoft.Json.Serialization.JsonSerializerInternalWriter.SerializeObject(JsonWriter writer, Object value, JsonObjectContract contract, JsonProperty member, JsonContainerContract collectionContract, JsonProperty containerProperty)
   at Newtonsoft.Json.Serialization.JsonSerializerInternalWriter.SerializeValue(JsonWriter writer, Object value, JsonContract valueContract, JsonProperty member, JsonContainerContract containerContract, JsonProperty containerProperty)
   at Newtonsoft.Json.Serialization.JsonSerializerInternalWriter.Serialize(JsonWriter jsonWriter, Object value, Type objectType)
   at Newtonsoft.Json.JsonSerializer.SerializeInternal(JsonWriter jsonWriter, Object value, Type objectType)
   at Newtonsoft.Json.JsonSerializer.Serialize(JsonWriter jsonWriter, Object value, Type objectType)
   at Newtonsoft.Json.JsonConvert.SerializeObjectInternal(Object value, Type type, JsonSerializer jsonSerializer)
   at Newtonsoft.Json.JsonConvert.SerializeObject(Object value, Type type, JsonSerializerSettings settings)
   at Newtonsoft.Json.JsonConvert.SerializeObject(Object value)
   at EventBus.RabbitMQ.EventBusRabbitMQ.Publish(IntegrationEvent event) in C:\Users\User\Desktop\PRO-JECT\src\EventBus.RabbitMQ\EventBusRabbitMQ.cs:line 85
   at Core.Application.Abstractions.CommandHandler`2.DispatchEventAsync(Result`2 result, CancellationToken cancellationToken) in C:\Users\User\Desktop\PRO-JECT\src\Core.Application\Abstractions\CommandHandler.cs:line 38
   at Core.Application.Abstractions.CommandHandler`2.Handle(TRequest request, CancellationToken cancellationToken) in C:\Users\User\Desktop\PRO-JECT\src\Core.Application\Abstractions\CommandHandler.cs:line 27
   at Core.Application.Behaviors.Validations.ValidationBehavior`2.Handle(TRequest request, RequestHandlerDelegate`1 next, CancellationToken cancellationToken) in C:\Users\User\Desktop\PRO-JECT\src\Core.Application\Behaviors\Validations\ValidationBehavior.cs:line 30
   at LoggingBehavior`2.Handle(TRequest request, RequestHandlerDelegate`1 next, CancellationToken cancellationToken) in C:\Users\User\Desktop\PRO-JECT\src\Core.Application\Behaviors\Logging\LoggingBehavior.cs:line 21
2025-04-13 13:04:24.995 +04:00 [INF] User profile is available. Using 'C:\Users\User\AppData\Local\ASP.NET\DataProtection-Keys' as key repository and Windows DPAPI to encrypt keys at rest.
2025-04-13 13:04:25.892 +04:00 [INF] Now listening on: https://localhost:7289
2025-04-13 13:04:25.896 +04:00 [INF] Now listening on: http://localhost:5287
2025-04-13 13:04:26.153 +04:00 [INF] Application started. Press Ctrl+C to shut down.
2025-04-13 13:04:26.490 +04:00 [INF] Hosting environment: Development
2025-04-13 13:04:26.494 +04:00 [INF] Content root path: C:\Users\User\Desktop\PRO-JECT\src\Web.Api
2025-04-13 13:04:50.339 +04:00 [INF] Request starting HTTP/1.1 POST https://localhost:7289/api/auth/login - application/json 41
2025-04-13 13:04:50.664 +04:00 [INF] Executing endpoint 'Web.Api.Controllers.AuthController.SignIn (Web.Api)'
2025-04-13 13:04:50.740 +04:00 [INF] Route matched with {action = "SignIn", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] SignIn(Core.Infrastructure.Persistence.Users.Features.Dtos.LoginDto) on controller Web.Api.Controllers.AuthController (Web.Api).
2025-04-13 13:04:50.938 +04:00 [INF] Handling request: UserRegisterOrLoginCommand, Data: {"email":"alizadeemil5@gmail.com","ipAddress":"0.0.0.1","$type":"UserRegisterOrLoginCommand"}
2025-04-13 13:04:57.746 +04:00 [INF] Executed DbCommand (108ms) [Parameters=[@__email_0='?' (Size = 50)], CommandType='"Text"', CommandTimeout='30']
SELECT [s0].[Id], [s0].[Bio], [s0].[Country], [s0].[CreatedDate], [s0].[DateOfBirth], [s0].[Email], [s0].[FirstName], [s0].[Gender], [s0].[LastName], [s0].[ModifiedDate], [s0].[Id0], [s1].[UserId], [s1].[RoleId], [s1].[Id], [s1].[Role], [s0].[CreatedDate0], [s0].[IPAddress], [s0].[ModifiedDate0], [s0].[OTPCode], [s0].[OTPExpiryDate], [s0].[RefreshToken], [s0].[RefreshTokenExpirationDate], [s0].[UserId]
FROM (
    SELECT TOP(1) [u].[Id], [u].[Bio], [u].[Country], [u].[CreatedDate], [u].[DateOfBirth], [u].[Email], [u].[FirstName], [u].[Gender], [u].[LastName], [u].[ModifiedDate], [s].[Id] AS [Id0], [s].[CreatedDate] AS [CreatedDate0], [s].[IPAddress], [s].[ModifiedDate] AS [ModifiedDate0], [s].[OTPCode], [s].[OTPExpiryDate], [s].[RefreshToken], [s].[RefreshTokenExpirationDate], [s].[UserId]
    FROM [Users] AS [u]
    LEFT JOIN [SecurityDetails] AS [s] ON [u].[Id] = [s].[UserId]
    WHERE [u].[Email] = @__email_0
) AS [s0]
LEFT JOIN (
    SELECT [u0].[UserId], [u0].[RoleId], [u1].[Id], [u1].[Role]
    FROM [UserAndUserRoles] AS [u0]
    INNER JOIN [UserRoles] AS [u1] ON [u0].[RoleId] = [u1].[Id]
) AS [s1] ON [s0].[Id] = [s1].[UserId]
ORDER BY [s0].[Id], [s0].[Id0], [s1].[UserId], [s1].[RoleId]
2025-04-13 13:04:57.954 +04:00 [INF] Executed DbCommand (17ms) [Parameters=[@__email_0='?' (Size = 50)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Users] AS [u]
        WHERE [u].[Email] = @__email_0) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-04-13 13:04:59.044 +04:00 [INF] Executed DbCommand (85ms) [Parameters=[@p8='?' (DbType = Guid), @p0='?' (DbType = DateTime2), @p1='?' (Size = 100), @p2='?' (DbType = DateTime2), @p3='?' (Size = 6), @p4='?' (DbType = DateTime2), @p5='?' (Size = 500), @p6='?' (DbType = DateTime2), @p7='?' (DbType = Guid), @p10='?' (DbType = Int32), @p9='?' (Size = 50), @p20='?' (DbType = Guid), @p11='?' (Size = 500), @p12='?' (Size = 50), @p13='?' (DbType = DateTime2), @p14='?' (DbType = DateTime2), @p15='?' (Size = 50), @p16='?' (Size = 50), @p17='?' (DbType = Int32), @p18='?' (Size = 50), @p19='?' (DbType = DateTime2)], CommandType='"Text"', CommandTimeout='30']
SET NOCOUNT ON;
UPDATE [SecurityDetails] SET [CreatedDate] = @p0, [IPAddress] = @p1, [ModifiedDate] = @p2, [OTPCode] = @p3, [OTPExpiryDate] = @p4, [RefreshToken] = @p5, [RefreshTokenExpirationDate] = @p6, [UserId] = @p7
OUTPUT 1
WHERE [Id] = @p8;
UPDATE [UserRoles] SET [Role] = @p9
OUTPUT 1
WHERE [Id] = @p10;
UPDATE [Users] SET [Bio] = @p11, [Country] = @p12, [CreatedDate] = @p13, [DateOfBirth] = @p14, [Email] = @p15, [FirstName] = @p16, [Gender] = @p17, [LastName] = @p18, [ModifiedDate] = @p19
OUTPUT 1
WHERE [Id] = @p20;
2025-04-13 13:04:59.618 +04:00 [INF] Request UserRegisterOrLoginCommand handled successfully.
2025-04-13 13:04:59.638 +04:00 [INF] Executing OkObjectResult, writing value of type 'Core.Application.Common.Result`2[[Core.Infrastructure.Persistence.Users.Features.Dtos.UserDto, Core.Infrastructure, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null],[Core.Application.Common.Error, Core.Application, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-04-13 13:04:59.870 +04:00 [INF] Executed action Web.Api.Controllers.AuthController.SignIn (Web.Api) in 9092.6405ms
2025-04-13 13:04:59.887 +04:00 [INF] Executed endpoint 'Web.Api.Controllers.AuthController.SignIn (Web.Api)'
2025-04-13 13:04:59.938 +04:00 [INF] Request finished HTTP/1.1 POST https://localhost:7289/api/auth/login - 200 null application/json; charset=utf-8 9615.4206ms
2025-04-13 13:05:32.128 +04:00 [INF] Request starting HTTP/1.1 POST https://localhost:7289/api/auth/verify-otp - application/json 62
2025-04-13 13:05:32.139 +04:00 [INF] Executing endpoint 'Web.Api.Controllers.AuthController.VerifyOTP (Web.Api)'
2025-04-13 13:05:32.215 +04:00 [INF] Route matched with {action = "VerifyOTP", controller = "Auth"}. Executing controller action with signature System.Threading.Tasks.Task`1[Microsoft.AspNetCore.Mvc.IActionResult] VerifyOTP(Core.Infrastructure.Persistence.Users.Features.Commands.VerifyOTPCommand.OTPValidateCommand) on controller Web.Api.Controllers.AuthController (Web.Api).
2025-04-13 13:05:32.245 +04:00 [INF] Handling request: OTPValidateCommand, Data: {"email":"alizadeemil5@gmail.com","OTP":"505954","$type":"OTPValidateCommand"}
2025-04-13 13:05:32.512 +04:00 [INF] Executed DbCommand (26ms) [Parameters=[@__email_0='?' (Size = 50), @__OTPCode_1='?' (Size = 6)], CommandType='"Text"', CommandTimeout='30']
SELECT TOP(1) [u].[Id], [u].[Bio], [u].[Country], [u].[CreatedDate], [u].[DateOfBirth], [u].[Email], [u].[FirstName], [u].[Gender], [u].[LastName], [u].[ModifiedDate], [s].[Id], [s].[CreatedDate], [s].[IPAddress], [s].[ModifiedDate], [s].[OTPCode], [s].[OTPExpiryDate], [s].[RefreshToken], [s].[RefreshTokenExpirationDate], [s].[UserId]
FROM [Users] AS [u]
LEFT JOIN [SecurityDetails] AS [s] ON [u].[Id] = [s].[UserId]
WHERE [u].[Email] = @__email_0 AND [s].[OTPCode] = @__OTPCode_1 AND [s].[OTPExpiryDate] > GETUTCDATE()
2025-04-13 13:05:32.568 +04:00 [INF] Executed DbCommand (12ms) [Parameters=[@__email_0='?' (Size = 50), @__OTPCode_1='?' (Size = 6)], CommandType='"Text"', CommandTimeout='30']
SELECT CASE
    WHEN EXISTS (
        SELECT 1
        FROM [Users] AS [u]
        LEFT JOIN [SecurityDetails] AS [s] ON [u].[Id] = [s].[UserId]
        WHERE [u].[Email] = @__email_0 AND [s].[OTPCode] = @__OTPCode_1 AND [s].[OTPExpiryDate] > GETUTCDATE()) THEN CAST(1 AS bit)
    ELSE CAST(0 AS bit)
END
2025-04-13 13:05:32.613 +04:00 [INF] Executed DbCommand (21ms) [Parameters=[@p8='?' (DbType = Guid), @p0='?' (DbType = DateTime2), @p1='?' (Size = 100), @p2='?' (DbType = DateTime2), @p3='?' (Size = 6), @p4='?' (DbType = DateTime2), @p5='?' (Size = 500), @p6='?' (DbType = DateTime2), @p7='?' (DbType = Guid), @p18='?' (DbType = Guid), @p9='?' (Size = 500), @p10='?' (Size = 50), @p11='?' (DbType = DateTime2), @p12='?' (DbType = DateTime2), @p13='?' (Size = 50), @p14='?' (Size = 50), @p15='?' (DbType = Int32), @p16='?' (Size = 50), @p17='?' (DbType = DateTime2)], CommandType='"Text"', CommandTimeout='30']
SET NOCOUNT ON;
UPDATE [SecurityDetails] SET [CreatedDate] = @p0, [IPAddress] = @p1, [ModifiedDate] = @p2, [OTPCode] = @p3, [OTPExpiryDate] = @p4, [RefreshToken] = @p5, [RefreshTokenExpirationDate] = @p6, [UserId] = @p7
OUTPUT 1
WHERE [Id] = @p8;
UPDATE [Users] SET [Bio] = @p9, [Country] = @p10, [CreatedDate] = @p11, [DateOfBirth] = @p12, [Email] = @p13, [FirstName] = @p14, [Gender] = @p15, [LastName] = @p16, [ModifiedDate] = @p17
OUTPUT 1
WHERE [Id] = @p18;
2025-04-13 13:05:32.625 +04:00 [INF] Request OTPValidateCommand handled successfully.
2025-04-13 13:05:32.629 +04:00 [INF] Executing OkObjectResult, writing value of type 'Core.Application.Common.Result`2[[Core.Infrastructure.Persistence.Users.Features.Dtos.VerificationOTPDto, Core.Infrastructure, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null],[Core.Application.Common.Error, Core.Application, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]]'.
2025-04-13 13:05:32.647 +04:00 [INF] Executed action Web.Api.Controllers.AuthController.VerifyOTP (Web.Api) in 428.2254ms
2025-04-13 13:05:32.650 +04:00 [INF] Executed endpoint 'Web.Api.Controllers.AuthController.VerifyOTP (Web.Api)'
2025-04-13 13:05:32.655 +04:00 [INF] Request finished HTTP/1.1 POST https://localhost:7289/api/auth/verify-otp - 200 null application/json; charset=utf-8 528.203ms
